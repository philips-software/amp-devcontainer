---
name: CI

on:
  merge_group:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions: {}

jobs:
  build-push-test:
    name: Build ‚Üí Push ‚Üí Test (üç® ${{ matrix.flavor }})
    strategy:
      matrix:
        flavor: [cpp, rust]
    uses: ./.github/workflows/wc-build-push-test.yml
    secrets:
      TEST_GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_TOKEN }}
      TEST_GITHUB_USER: ${{ secrets.TEST_GITHUB_USER }}
      TEST_GITHUB_PASSWORD: ${{ secrets.TEST_GITHUB_PASSWORD }}
      TEST_GITHUB_TOTP_SECRET: ${{ secrets.TEST_GITHUB_TOTP_SECRET }}
    permissions:
      actions: read # is needed by anchore/sbom-action to find workflow artifacts when attaching release assets
      attestations: write # is needed by actions/attest-build-provenance to push attestations
      contents: write # is needed by anchore/sbom-action for artifact uploads
      id-token: write # is needed by actions/attest-build-provenance to obtain an OIDC token
      packages: write # is needed to push image manifest when using GitHub Container Registry
      pull-requests: write # is needed by marocchino/sticky-pull-request-comment to post comments
    with:
      devcontainer-metadata-file: .devcontainer/${{ matrix.flavor }}/devcontainer-metadata.json
      dockerfile: .devcontainer/${{ matrix.flavor }}/Dockerfile
      image-name: ${{ github.repository }}-${{ matrix.flavor }}
      integration-test-file: test/${{ matrix.flavor }}/integration-tests.bats
      acceptance-test-path: ${{ matrix.flavor == 'cpp' && 'test/cpp/features' || '' }}
      test-devcontainer-file: ${{ matrix.flavor == 'cpp' && '.devcontainer/cpp-test/devcontainer.json' || '' }}

  dependency-review:
    name: üîç Dependency Review
    needs: build-push-test
    uses: ./.github/workflows/wc-dependency-review.yml
    permissions:
      contents: read
      pull-requests: write # is needed by actions/dependency-review-action to write PR summaries

  publish-test-results:
    name: üìä Publish Test Results
    runs-on: ubuntu-latest
    permissions:
      checks: write # is needed by EnricoMi/publish-unit-test-result-action to add a check run with test results
      pull-requests: write # is needed by EnricoMi/publish-unit-test-result-action to annotate PRs
    needs: build-push-test
    if: ${{ !cancelled() }}
    steps:
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          disable-sudo: true
          egress-policy: audit
      - uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          merge-multiple: true
          pattern: test-results-*
      - uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf # v2.21.0
        with:
          files: test-report-*.xml

  publish-devcontainer-templates:
    name: üìù Publish templates
    runs-on: ubuntu-latest
    permissions:
      packages: write # is needed by devcontainers/action to write templates as OCI artifacts
    steps:
      - uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          disable-sudo: true
          egress-policy: audit
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}
      - uses: devcontainers/action@1082abd5d2bf3a11abccba70eef98df068277772 # v1.4.3
        with:
          disable-repo-tagging: true
          publish-templates: true
          base-path-to-templates: .devcontainer

  generate-documents:
    name: üìÑ Documentation
    uses: ./.github/workflows/wc-document-generation.yml
    permissions:
      contents: read
